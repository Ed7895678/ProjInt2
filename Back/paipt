const puppeteer = require('puppeteer');
const fs = require('fs-extra');
const path = require('path');
const readline = require('readline');

// Fun√ß√£o para pausar a execu√ß√£o por um determinado tempo (ms)
const delay = (time) => new Promise(resolve => setTimeout(resolve, time));

// Fun√ß√£o para ler empresas a partir do arquivo empresas.txt
async function lerEmpresas(caminhoArquivo) {
    const empresas = [];
    const fileStream = fs.createReadStream(caminhoArquivo);

    const rl = readline.createInterface({
        input: fileStream,
        crlfDelay: Infinity
    });

    for await (const line of rl) {
        const empresa = line.trim();
        if (empresa) { // Ignora linhas vazias
            empresas.push(empresa);
        }
    }

    return empresas;
}

async function buscarReviews() {
    // Caminho para o arquivo de empresas
    // Use o caminho absoluto fornecido pelo usu√°rio
    const caminhoEmpresas = "C:\\Users\\pedro\\paipt\\empresas.txt";

    // Verifica se o arquivo existe
    if (!fs.existsSync(caminhoEmpresas)) {
        console.error(`Arquivo "empresas.txt" n√£o encontrado no diret√≥rio ${caminhoEmpresas}`);
        process.exit(1);
    }

    // L√™ a lista de empresas
    const empresas = await lerEmpresas(caminhoEmpresas);
    console.log(`Total de empresas a serem pesquisadas: ${empresas.length}`);

    // Define o caminho para o arquivo de resultados no formato JSON Lines
    const caminhoArquivoResultados = path.join(__dirname, 'resultados_reviews.jsonl');

    // Se o arquivo n√£o existir, cria um vazio
    if (!fs.existsSync(caminhoArquivoResultados)) {
        fs.writeFileSync(caminhoArquivoResultados, '');
    }

    // Lan√ßa o navegador
    const browser = await puppeteer.launch({ headless: true });
    const page = await browser.newPage();

    // Opcional: Configurar User-Agent para imitar um navegador real
    await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) ' +
                            'AppleWebKit/537.36 (KHTML, like Gecko) ' +
                            'Chrome/112.0.0.0 Safari/537.36');

    try {
        for (const [index, empresa] of empresas.entries()) {
            console.log(`\n[${index + 1}/${empresas.length}] Pesquisando empresa: ${empresa}`);

            // Navega para a p√°gina inicial do pai.pt
            try {
                await page.goto('https://www.pai.pt/', { waitUntil: 'networkidle2', timeout: 30000 });
            } catch (e) {
                console.error(`‚Üí Erro ao navegar para a p√°gina inicial do pai.pt para a empresa: ${empresa}`);
                const resultadoErro = {
                    empresa,
                    link: null,
                    resumoAvaliacoes: null,
                    avaliacoes: [],
                    erro: 'Erro ao carregar a p√°gina inicial do pai.pt'
                };
                await fs.appendFile(caminhoArquivoResultados, JSON.stringify(resultadoErro) + '\n');
                continue; // Pula para a pr√≥xima empresa
            }

            // Aguarda o campo de pesquisa estar dispon√≠vel
            const campoPesquisaSelector = '#search_query';
            try {
                await page.waitForSelector(campoPesquisaSelector, { timeout: 10000 });
            } catch (e) {
                console.error(`‚Üí Tempo de espera excedido para o campo de pesquisa: ${empresa}`);
                const resultadoErro = {
                    empresa,
                    link: null,
                    resumoAvaliacoes: null,
                    avaliacoes: [],
                    erro: 'Campo de pesquisa n√£o encontrado'
                };
                await fs.appendFile(caminhoArquivoResultados, JSON.stringify(resultadoErro) + '\n');
                continue; // Pula para a pr√≥xima empresa
            }

            // Seleciona todo o texto existente no campo de pesquisa e insere o nome da empresa
            try {
                await page.click(campoPesquisaSelector, { clickCount: 3 });
                await page.type(campoPesquisaSelector, empresa, { delay: 100 }); // Digita√ß√£o mais humana
            } catch (e) {
                console.error(`‚Üí Erro ao inserir o nome da empresa no campo de pesquisa: ${empresa}`);
                const resultadoErro = {
                    empresa,
                    link: null,
                    resumoAvaliacoes: null,
                    avaliacoes: [],
                    erro: 'Erro ao inserir nome no campo de pesquisa'
                };
                await fs.appendFile(caminhoArquivoResultados, JSON.stringify(resultadoErro) + '\n');
                continue; // Pula para a pr√≥xima empresa
            }

            // Clica no bot√£o de pesquisa
            const botaoPesquisaSelector = 'input[type="submit"][name="commit"]';
            try {
                await Promise.all([
                    page.click(botaoPesquisaSelector),
                    page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 30000 })
                ]);
            } catch (e) {
                console.error(`‚Üí Erro ao realizar a pesquisa para a empresa: ${empresa}`);
                const resultadoErro = {
                    empresa,
                    link: null,
                    resumoAvaliacoes: null,
                    avaliacoes: [],
                    erro: 'Erro ao clicar no bot√£o de pesquisa ou aguardar a navega√ß√£o'
                };
                await fs.appendFile(caminhoArquivoResultados, JSON.stringify(resultadoErro) + '\n');
                continue; // Pula para a pr√≥xima empresa
            }

            // Verifica se a p√°gina exibe a mensagem de "nenhum resultado encontrado"
            const notFoundSelector = 'h2.not-found-title';
            let isNotFound = false;
            try {
                await page.waitForSelector(notFoundSelector, { timeout: 5000 });
                isNotFound = true;
            } catch (e) {
                isNotFound = false;
            }

            if (isNotFound) {
                console.log(`‚Üí Nenhum resultado encontrado para a empresa: ${empresa}`);
                const resultado = {
                    empresa,
                    link: null,
                    resumoAvaliacoes: null,
                    avaliacoes: []
                };
                await fs.appendFile(caminhoArquivoResultados, JSON.stringify(resultado) + '\n');
                continue; // Pula para a pr√≥xima empresa
            }

            // Verifica se h√° resultados de pesquisa v√°lidos
            const resultadoSelector = 'a.card-link';
            let resultadosEncontrados = [];
            try {
                resultadosEncontrados = await page.$$(resultadoSelector);
            } catch (e) {
                resultadosEncontrados = [];
            }

            if (resultadosEncontrados.length > 0) {
                // Seleciona o primeiro resultado da pesquisa
                let linkEmpresa = null;
                try {
                    linkEmpresa = await page.$eval(resultadoSelector, el => el.href);
                } catch (e) {
                    linkEmpresa = null;
                }

                if (linkEmpresa) {
                    console.log(`‚Üí Encontrada p√°gina da empresa: ${linkEmpresa}`);

                    // Navega para a p√°gina da empresa
                    try {
                        await page.goto(linkEmpresa, { waitUntil: 'networkidle2', timeout: 30000 });
                    } catch (e) {
                        console.error(`‚Üí Erro ao navegar para a p√°gina da empresa: ${empresa}`);
                        const resultadoErro = {
                            empresa,
                            link: linkEmpresa,
                            resumoAvaliacoes: null,
                            avaliacoes: [],
                            erro: 'Erro ao carregar a p√°gina da empresa'
                        };
                        await fs.appendFile(caminhoArquivoResultados, JSON.stringify(resultadoErro) + '\n');
                        continue; // Pula para a pr√≥xima empresa
                    }

                    // Verifica se a se√ß√£o de reviews existe
                    const reviewsContainerSelector = '.reviews-container';
                    let existeReviews = false;
                    try {
                        await page.waitForSelector(reviewsContainerSelector, { timeout: 5000 });
                        existeReviews = true;
                    } catch (e) {
                        existeReviews = false;
                    }

                    let resumoAvaliacoes = null;
                    let todasAvaliacoes = [];

                    if (existeReviews) {
                        // Extrai a m√©dia de avalia√ß√µes e o n√∫mero total de avalia√ß√µes
                        try {
                            resumoAvaliacoes = await page.evaluate(() => {
                                const mediaElement = document.querySelector('.rating-review');
                                const totalElement = document.querySelector('.reviews-container .rating-grid .cell.small-3 p');

                                let mediaEstrelas = 'N/A';
                                let totalAvaliacoes = 'N/A';

                                if (mediaElement) {
                                    const estrelas = Array.from(mediaElement.querySelectorAll('.star'));
                                    mediaEstrelas = estrelas.reduce((acc, star) => {
                                        if (star.classList.contains('filled')) return acc + 1;
                                        else if (star.classList.contains('half-filled')) return acc + 0.5;
                                        return acc;
                                    }, 0);
                                }

                                if (totalElement) {
                                    const textoTotal = totalElement.innerText.trim();
                                    const match = textoTotal.match(/\d+/);
                                    totalAvaliacoes = match ? match[0] : 'N/A';
                                }

                                return { mediaEstrelas, totalAvaliacoes };
                            });
                        } catch (e) {
                            resumoAvaliacoes = { mediaEstrelas: 'N/A', totalAvaliacoes: 'N/A' };
                        }

                        console.log(`‚Üí Resumo das avalia√ß√µes: M√©dia de ${resumoAvaliacoes.mediaEstrelas} estrelas, Total de ${resumoAvaliacoes.totalAvaliacoes} avalia√ß√µes`);

                        // Fun√ß√£o para extrair as reviews de uma p√°gina
                        const extrairReviews = async () => {
                            try {
                                return await page.evaluate(() => {
                                    const reviews = [];
                                    const elementos = document.querySelectorAll('.review-container');

                                    elementos.forEach(el => {
                                        // Autor da avalia√ß√£o
                                        const autor = el.querySelector('.review-sub > strong')?.innerText.trim() || 'N/A';

                                        // Nota da avalia√ß√£o (n√∫mero de estrelas)
                                        const estrelasFilled = el.querySelectorAll('.rating-review-small .star.filled').length;
                                        const estrelasHalfFilled = el.querySelectorAll('.rating-review-small .star.half-filled').length;
                                        const estrelas = estrelasFilled + (estrelasHalfFilled * 0.5);

                                        // Conte√∫do da avalia√ß√£o
                                        const conteudo = el.querySelector('.review-content')?.innerText.trim() || 'N/A';

                                        // Data da avalia√ß√£o
                                        const data = el.querySelector('.review-meta span.ml-5')?.innerText.trim() || 'N/A';

                                        reviews.push({ autor, estrelas, conteudo, data });
                                    });

                                    return reviews;
                                });
                            } catch (e) {
                                return [];
                            }
                        };

                        // Extrai as reviews da primeira p√°gina
                        try {
                            todasAvaliacoes = await extrairReviews();
                            console.log(`‚Üí Avalia√ß√µes encontradas na primeira p√°gina: ${todasAvaliacoes.length}`);
                        } catch (e) {
                            todasAvaliacoes = [];
                            console.error(`‚Üí Erro ao extrair avalia√ß√µes da empresa: ${empresa}`);
                        }

                        // Verifica se h√° mais p√°ginas de avalia√ß√µes
                        let proximaPagina = true;
                        let numeroPagina = 1;

                        while (proximaPagina) {
                            // Tenta encontrar o bot√£o de "Seguinte ‚Ä∫"
                            let botaoProxima = null;
                            try {
                                botaoProxima = await page.$('li.next a[rel="next"]');
                            } catch (e) {
                                botaoProxima = null;
                            }

                            if (botaoProxima) {
                                numeroPagina += 1;
                                console.log(`‚Üí Navegando para a p√°gina de avalia√ß√µes: ${numeroPagina}`);

                                // Clica no bot√£o de pr√≥xima p√°gina e aguarda a navega√ß√£o
                                try {
                                    await Promise.all([
                                        botaoProxima.click(),
                                        page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 30000 })
                                    ]);
                                } catch (e) {
                                    console.error(`‚Üí Erro ao navegar para a p√°gina de avalia√ß√µes ${numeroPagina} da empresa: ${empresa}`);
                                    break; // Sai do loop de p√°ginas
                                }

                                // Extrai as reviews da nova p√°gina
                                let reviewsPagina = [];
                                try {
                                    reviewsPagina = await extrairReviews();
                                    console.log(`‚Üí Avalia√ß√µes encontradas na p√°gina ${numeroPagina}: ${reviewsPagina.length}`);
                                } catch (e) {
                                    reviewsPagina = [];
                                    console.error(`‚Üí Erro ao extrair avalia√ß√µes da p√°gina ${numeroPagina} da empresa: ${empresa}`);
                                }

                                // Adiciona as novas avalia√ß√µes ao array total
                                todasAvaliacoes = todasAvaliacoes.concat(reviewsPagina);

                                // Pausa aleat√≥ria entre 1 a 3 segundos para evitar sobrecarga
                                const pausa = Math.floor(Math.random() * 2000) + 1000;
                                await delay(pausa);
                            } else {
                                proximaPagina = false; // N√£o h√° mais p√°ginas
                            }
                        }

                    } else {
                        console.log(`‚Üí Nenhuma p√°gina encontrada para a empresa: ${empresa}`);
                    }

                    // Cria o objeto de resultado para a empresa atual
                    const resultado = {
                        empresa,
                        link: linkEmpresa,
                        resumoAvaliacoes,
                        avaliacoes: todasAvaliacoes
                    };

                    // Salva o resultado no arquivo JSON Lines
                    try {
                        await fs.appendFile(caminhoArquivoResultados, JSON.stringify(resultado) + '\n');
                        console.log(`‚Üí Resultado salvo para a empresa: ${empresa}`);
                    } catch (e) {
                        console.error(`‚Üí Erro ao salvar o resultado para a empresa: ${empresa}`);
                    }

                    // Pausa aleat√≥ria entre 2 a 5 segundos entre pesquisas para evitar sobrecarga
                    const pausaPesquisa = Math.floor(Math.random() * 3000) + 2000;
                    await delay(pausaPesquisa);
                } else {
                    console.log(`‚Üí Nenhuma p√°gina encontrada para a empresa: ${empresa}`);
                    const resultado = {
                        empresa,
                        link: null,
                        resumoAvaliacoes: null,
                        avaliacoes: []
                    };
                    await fs.appendFile(caminhoArquivoResultados, JSON.stringify(resultado) + '\n');
                }
            }
        }
        console.log(`\nüîç Todas as pesquisas conclu√≠das. Resultados salvos em "${caminhoArquivoResultados}"`);
    } catch (error) {
        console.error('‚ö†Ô∏è Erro durante a execu√ß√£o:', error);
    } finally {
        await browser.close();
    }
}

// Executa a fun√ß√£o principal
buscarReviews();

